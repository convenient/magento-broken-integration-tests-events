name: Elasticsearch Boot Matrix test123
on:
  push:
    branches:
      - '**'
  pull_request:
  schedule:
    - cron: '0 7 * * 2'
  workflow_dispatch:

jobs:
  elasticsearch-boot:
    name: "ES Boot ${{ matrix.es_version }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - es_version: "7.8"
            es_image: "docker.io/wardenenv/elasticsearch:7.8"
            es_java_opts: "-Xms64m -Xmx512m"
            java_tool_options: ""
            cli_java_opts: ""
            es_service_options: ""
          - es_version: "7.16"
            es_image: "docker.io/wardenenv/elasticsearch:7.16"
            es_java_opts: "-Xms64m -Xmx512m"
            java_tool_options: ""
            cli_java_opts: ""
            es_service_options: ""
          - es_version: "7.17"
            es_image: "docker.io/wardenenv/elasticsearch:7.17"
            es_java_opts: "-Xms64m -Xmx512m"
            java_tool_options: ""
            cli_java_opts: ""
            es_service_options: ""
          - es_version: "8.1"
            es_image: "docker.io/wardenenv/elasticsearch:8.1"
            es_java_opts: "-Xms64m -Xmx512m -XX:+IgnoreUnrecognizedVMOptions -XX:-UseContainerSupport -Dlog4j2.disable.jmx=true -Des.cgroups.hierarchy.override=/"
            java_tool_options: "-XX:+IgnoreUnrecognizedVMOptions -XX:-UseContainerSupport"
            cli_java_opts: "-XX:+IgnoreUnrecognizedVMOptions -XX:-UseContainerSupport -Dlog4j2.disable.jmx=true -Des.cgroups.hierarchy.override=/"
            es_service_options: "--ulimit memlock=-1:-1 --security-opt seccomp=unconfined --cgroupns=host -v /sys/fs/cgroup:/sys/fs/cgroup:ro --privileged"
          - es_version: "8.2"
            es_image: "docker.io/wardenenv/elasticsearch:8.2"
            es_java_opts: "-Xms64m -Xmx512m -XX:+IgnoreUnrecognizedVMOptions -XX:-UseContainerSupport -Dlog4j2.disable.jmx=true -Des.cgroups.hierarchy.override=/"
            java_tool_options: "-XX:+IgnoreUnrecognizedVMOptions -XX:-UseContainerSupport"
            cli_java_opts: "-XX:+IgnoreUnrecognizedVMOptions -XX:-UseContainerSupport -Dlog4j2.disable.jmx=true -Des.cgroups.hierarchy.override=/"
            es_service_options: "--ulimit memlock=-1:-1 --security-opt seccomp=unconfined --cgroupns=host -v /sys/fs/cgroup:/sys/fs/cgroup:ro --privileged"
          - es_version: "8.3"
            es_image: "docker.io/wardenenv/elasticsearch:8.3"
            es_java_opts: "-Xms64m -Xmx512m -XX:+IgnoreUnrecognizedVMOptions -XX:-UseContainerSupport -Dlog4j2.disable.jmx=true -Des.cgroups.hierarchy.override=/"
            java_tool_options: "-XX:+IgnoreUnrecognizedVMOptions -XX:-UseContainerSupport"
            cli_java_opts: "-XX:+IgnoreUnrecognizedVMOptions -XX:-UseContainerSupport -Dlog4j2.disable.jmx=true -Des.cgroups.hierarchy.override=/"
            es_service_options: "--ulimit memlock=-1:-1 --security-opt seccomp=unconfined --cgroupns=host -v /sys/fs/cgroup:/sys/fs/cgroup:ro --privileged"
          - es_version: "8.4"
            es_image: "docker.io/wardenenv/elasticsearch:8.4"
            es_java_opts: "-Xms64m -Xmx512m -XX:+IgnoreUnrecognizedVMOptions -XX:-UseContainerSupport -Dlog4j2.disable.jmx=true -Des.cgroups.hierarchy.override=/"
            java_tool_options: "-XX:+IgnoreUnrecognizedVMOptions -XX:-UseContainerSupport"
            cli_java_opts: "-XX:+IgnoreUnrecognizedVMOptions -XX:-UseContainerSupport -Dlog4j2.disable.jmx=true -Des.cgroups.hierarchy.override=/"
            es_service_options: "--ulimit memlock=-1:-1 --security-opt seccomp=unconfined --cgroupns=host -v /sys/fs/cgroup:/sys/fs/cgroup:ro --privileged"
    services:
      es:
        image: ${{ matrix.es_image }}
        ports:
          - 9200:9200
        env:
          discovery.type: single-node
          xpack.security.enabled: "false"
          ES_JAVA_OPTS: ${{ matrix.es_java_opts }}
          JAVA_TOOL_OPTIONS: ${{ matrix.java_tool_options }}
          CLI_JAVA_OPTS: ${{ matrix.cli_java_opts }}
        options: >-
          ${{ matrix.es_service_options }}
          --health-cmd="curl -fsS http://localhost:9200/_cluster/health?wait_for_status=yellow&timeout=60s || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=12
          --health-start-period=30s
    steps:
      - name: Print ES Service Debug
        run: |
          set -euo pipefail

          echo "==== Elasticsearch launch debug ===="
          echo "es_version=${{ matrix.es_version }}"
          echo "es_image=${{ matrix.es_image }}"
          echo "es_service_options=${{ matrix.es_service_options }}"
          echo "es_java_opts=${{ matrix.es_java_opts }}"
          echo "java_tool_options=${{ matrix.java_tool_options }}"
          echo "cli_java_opts=${{ matrix.cli_java_opts }}"
          docker version --format 'docker_client_api={{.Client.APIVersion}} docker_server_api={{.Server.APIVersion}}'
          docker ps -a

      - name: Wait for Elasticsearch health
        run: |
          set -euo pipefail
          for attempt in $(seq 1 60); do
            if curl -fsS "http://localhost:9200/_cluster/health?wait_for_status=yellow&timeout=1s" >/dev/null; then
              echo "Elasticsearch ${{ matrix.es_version }} is healthy"
              exit 0
            fi

            if [ "$((attempt % 10))" -eq 0 ]; then
              echo "Still waiting for Elasticsearch ${{ matrix.es_version }} (${attempt}/60)..."
            fi
            sleep 2
          done
          echo "Elasticsearch ${{ matrix.es_version }} did not become healthy in time"
          exit 1

      - name: Print Elasticsearch logs
        if: always()
        run: |
          ES_CONTAINER_ID="$(docker ps -a --filter "ancestor=${{ matrix.es_image }}" --format '{{.ID}}' | head -n1 || true)"
          if [ -n "${ES_CONTAINER_ID}" ]; then
            echo "===== Elasticsearch service logs (${ES_CONTAINER_ID}) ====="
            docker inspect "${ES_CONTAINER_ID}" || true
            docker logs "${ES_CONTAINER_ID}" || true
          else
            echo "No Elasticsearch service container found for image ${{ matrix.es_image }}"
          fi
