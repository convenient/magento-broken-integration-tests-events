name: Elasticsearch Boot Matrix test123
on:
  push:
    branches:
      - '**'
  pull_request:
  schedule:
    - cron: '0 7 * * 2'
  workflow_dispatch:

jobs:
  elasticsearch-boot:
    name: "ES Boot ${{ matrix.es_version }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - es_version: "7.8"
            es_image: "docker.io/wardenenv/elasticsearch:7.8"
          - es_version: "7.16"
            es_image: "docker.io/wardenenv/elasticsearch:7.16"
          - es_version: "7.17"
            es_image: "docker.io/wardenenv/elasticsearch:7.17"
          - es_version: "8.1"
            es_image: "docker.io/wardenenv/elasticsearch:8.1"
          - es_version: "8.2"
            es_image: "docker.io/wardenenv/elasticsearch:8.2"
          - es_version: "8.3"
            es_image: "docker.io/wardenenv/elasticsearch:8.3"
          - es_version: "8.4"
            es_image: "docker.io/wardenenv/elasticsearch:8.4"
    steps:
      - name: Start Elasticsearch
        run: |
          set -euo pipefail
      
          CONTAINER_NAME="es-${{ matrix.es_version }}-${{ github.run_id }}-${{ github.run_attempt }}"
          echo "CONTAINER_NAME=${CONTAINER_NAME}" >> "${GITHUB_ENV}"
      
          # Ensure required kernel setting for Elasticsearch
          sudo sysctl -w vm.max_map_count=262144

          EXTRA_DOCKER_FLAGS=""
          ES_JAVA_OPTS="-Xms64m -Xmx512m"
          if [[ "${{ matrix.es_version }}" =~ ^8\. ]]; then
            EXTRA_DOCKER_FLAGS="--ulimit memlock=-1:-1 --security-opt seccomp=unconfined --cgroupns=host"
            ES_JAVA_OPTS="${ES_JAVA_OPTS} -XX:-UseContainerSupport -Des.cgroups.hierarchy.override=/"
          fi

          docker pull "${{ matrix.es_image }}"
          docker run -d \
            --name "${CONTAINER_NAME}" \
            -p 9200:9200 \
            -e discovery.type=single-node \
            -e xpack.security.enabled=false \
            -e ES_JAVA_OPTS="${ES_JAVA_OPTS}" \
            ${EXTRA_DOCKER_FLAGS} \
            "${{ matrix.es_image }}"

      - name: Wait for Elasticsearch health
        run: |
          set -euo pipefail
          for attempt in $(seq 1 60); do
            if [ "$(docker inspect -f '{{.State.Status}}' "${CONTAINER_NAME}" 2>/dev/null || echo missing)" != "running" ]; then
              echo "Elasticsearch container exited before becoming healthy"
              docker logs "${CONTAINER_NAME}" || true
              exit 1
            fi

            if curl -fsS "http://localhost:9200/_cluster/health?wait_for_status=yellow&timeout=1s" >/dev/null; then
              echo "Elasticsearch ${{ matrix.es_version }} is healthy"
              exit 0
            fi

            if [ "$((attempt % 10))" -eq 0 ]; then
              echo "Still waiting for Elasticsearch ${{ matrix.es_version }} (${attempt}/60)..."
            fi
            sleep 2
          done
          echo "Elasticsearch ${{ matrix.es_version }} did not become healthy in time"
          exit 1

      - name: Print Elasticsearch logs
        if: always()
        run: |
          if [ -n "${CONTAINER_NAME:-}" ]; then
            echo "===== Elasticsearch logs (${CONTAINER_NAME}) ====="
            docker logs "${CONTAINER_NAME}" || true
          fi

      - name: Remove Elasticsearch container
        if: always()
        run: |
          if [ -n "${CONTAINER_NAME:-}" ]; then
            docker rm -f "${CONTAINER_NAME}" >/dev/null 2>&1 || true
          fi
